var _=Object.defineProperty;var q=(z,d,p)=>d in z?_(z,d,{enumerable:!0,configurable:!0,writable:!0,value:p}):z[d]=p;var x=(z,d,p)=>(q(z,typeof d!="symbol"?d+"":d,p),p);(function(){"use strict";function p(f){return 100-(70+(f-1)/(9-1)*(95-70))}function V(f){const o=5+Math.floor((f-1)/8*5);return Math.min(o,9)}class C{constructor(e){this.seed=e}getNext(e,t){return t===void 0?this.next(0,e):this.next(e,t)}pick(e){return e[this.getNext(0,e.length-1)]}shuffle(e){const t=[...e];for(let o=t.length-1;o>0;o--){const n=this.getNext(0,o);[t[o],t[n]]=[t[n],t[o]]}return t}}class H extends C{constructor(t){super(t);x(this,"index");this.index=t}next(t,o){if(o<=t)return t;this.index=this.index*1664525+1013904223>>>0;const n=o-t+1;return t+this.index%n}}function S(f){return new H(f)}class y{constructor(e,t,o){x(this,"solution");x(this,"skeleton");this.board=e;const n=F(e),r=y.solve(n,Array.from({length:e.cellcount},()=>0),o);if(r===null)throw new Error("Unsolvable board");this.solution=r,this.skeleton=[...this.solution];const i=o.shuffle(Array.from({length:e.cellcount},(h,m)=>m));for(const h of i){const m=this.skeleton[h];this.skeleton[h]=0;const I=k(h,n,this.skeleton).filter(w=>w!==m);if(I.length===0)continue;let E=!1;for(const w of I)if(this.skeleton[h]=w,y.solve(n,[...this.skeleton],o)!==null){E=!0;break}this.skeleton[h]=E?m:0}for(let h=0;h<e.size;h++)for(let m=0;m<e.size;m++){const I=h*e.size+m,E=e.rows[h],w=e.columns[m];let N=!1,O=!1,G=!1,R=!1,g=0;for(const M of E)m===g&&(N=!0),g+=M-1,m===g&&(O=!0),g+=1;g=0;for(const M of w)h===g&&(G=!0),g+=M-1,h===g&&(R=!0),g+=1;N&&O&&G&&R&&(this.skeleton[I]=1)}const s=p(t),l=o.shuffle(Array.from({length:e.cellcount},(h,m)=>new v(m)).filter(h=>h.getValue(this.skeleton)===0)).map(h=>h.index),c=Math.floor(e.cellcount*(s/100)),u=e.cellcount-l.length,a=Math.max(0,c-u);l.slice(0,a).forEach(h=>{const m=this.solution[h];this.skeleton[h]=m})}static undo(e,t,o){for(let n=t.length-1;n>=o;n--)e[t[n]]=0;t.length=o}static propagate(e,t,o){let n=!0;for(;n;){n=!1;for(let r=0;r<t.length;r++){if(t[r]!==0)continue;const i=k(r,e,t);if(i.length===0)return!1;i.length===1&&(t[r]=i[0],o.push(r),n=!0)}}return!0}static solve(e,t,o,n=[]){if(!this.propagate(e,t,n))return null;let r,i;for(let s=0;s<t.length;s++){if(t[s]!==0)continue;const l=k(s,e,t);if(l.length===0)return null;if((i===void 0||l.length<i.length)&&(r=s,i=l,l.length===1))break}if(r===void 0)return t;for(const s of i){t[r]=s;const l=n.length,c=this.solve(e,t,o,n);if(c!==null)return c;this.undo(t,n,l),t[r]=0}return null}}function k(f,e,t){const o=e[f].colSegment.map(l=>l.getValue(t)),n=e[f].rowSegment.map(l=>l.getValue(t)),r=new Set([...o,...n].filter(l=>l!==0)),i=Math.min(o.length,n.length),s=[];for(let l=1;l<=i;l++)r.has(l)||s.push(l);return s}class v{constructor(e){this.index=e}getValue(e){return e[this.index]}}function F(f){const e={},t=(o,n)=>o*f.size+n;for(let o=0;o<f.size;o++)for(let n=0;n<f.size;n++){const r=t(o,n),i=[];let s=0;for(const c of f.rows[o]){const u=s+c;if(n>=s&&n<u){for(let a=s;a<u;a++)i.push(new v(t(o,a)));break}s=u}const l=[];s=0;for(const c of f.columns[n]){const u=s+c;if(o>=s&&o<u){for(let a=s;a<u;a++)l.push(new v(t(a,n)));break}s=u}e[r]={rowSegment:i,colSegment:l}}return e}function B(f,e,t){return new y(f,e,t)}class L{constructor(e,t){x(this,"cellcount");x(this,"rows");x(this,"columns");if(this.size=e,e<5)throw new Error(`Size ${e} is too small`);this.cellcount=this.size*this.size;const o=Array.from({length:this.size},(u,a)=>a),n=Math.max(Math.floor(this.size/2-1)-t.getNext(1),2),r=t.shuffle([...o]).slice(0,n),i=t.shuffle([...o]).slice(0,n),s=Array.from({length:this.size},()=>{});for(const u of r)s[u]=[this.size];const l=Array.from({length:this.size},()=>{});for(const u of i)l[u]=[this.size];if(!A(s,l,t))throw new Error("Unsolvable div board");this.rows=s.map(u=>u.map(a=>a)),this.columns=l.map(u=>u.map(a=>a))}}function W(f,e){const t=f.length,o=Array.from({length:t},()=>Array(t).fill(0)),n=Array.from({length:t},()=>Array(t).fill(0)),r=(i,s)=>{let l=0;for(let c=0;c<i.length;c++){const u=i[c];if(l<=s&&l+u>s)return c;l+=u}throw Error(`Unable to find value ${s} in ${i}`)};for(let i=0;i<t;i++)for(let s=0;s<t;s++){const l=s,c=r(e[l],i);o[i][s]=e[l][c]}for(let i=0;i<t;i++)for(let s=0;s<t;s++){const l=s,c=r(f[l],i);n[i][s]=f[l][c]}return{rowMap:o,colMap:n}}function T(f,e){const t=f.length,{rowMap:o,colMap:n}=W(f,e);for(let r=0;r<t;r++){let i=0;for(const s of f[r]){const l=o[r].slice(i,i+s).sort((c,u)=>u-c);for(let c=0;c<s;c++){const u=s-c;if(l[c]<u)return!1}i+=s}}for(let r=0;r<t;r++){let i=0;for(const s of e[r]){const l=n[r].slice(i,i+s).sort((c,u)=>u-c);for(let c=0;c<s;c++){const u=s-c;if(l[c]<u)return!1}i+=s}}return!0}function A(f,e,t){const o=f.length,n=f.findIndex(l=>l===void 0),r=n===-1?e.findIndex(l=>l===void 0):-1;if(n===-1&&r===-1)return!0;const i={get(){return n!==-1?f[n]:e[r]},set(l){n!==-1?f[n]=l:e[r]=l},reset(){this.set(void 0)}},s=t.shuffle(Array.from({length:o-1},(l,c)=>[c+1,o-(c+1)]));for(const l of s)if(i.set(l),!!T([...f].map(c=>c===void 0?[o]:c),[...e].map(c=>c===void 0?[o]:c))&&A(f,e,t))return!0;return i.reset(),!1}function U(f,e){const t=V(f);for(;;){const o=e.getNext(Number.MAX_SAFE_INTEGER),n=S(o),r=new L(t,n);let i;try{i=B(r,f,n)}catch(s){if(s.message!=="Unsolvable board")throw s}if(i)return[r,i]}}self.onmessage=async f=>{const{level:e,difficulty:t}=f.data,o=S(e);try{const[n,r]=U(t,o),i={board:n,solution:r};self.postMessage(i)}catch(n){const r={error:n.message};self.postMessage(r)}}})();
