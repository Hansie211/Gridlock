var _=Object.defineProperty;var q=(z,g,p)=>g in z?_(z,g,{enumerable:!0,configurable:!0,writable:!0,value:p}):z[g]=p;var x=(z,g,p)=>(q(z,typeof g!="symbol"?g+"":g,p),p);(function(){"use strict";function p(c){return 100-(70+(c-1)/(9-1)*(95-70))}function V(c){const l=5+Math.floor((c-1)/8*5);return Math.min(l,9)}class C{constructor(e){this.seed=e}getNext(e,t){return t===void 0?this.next(0,e):this.next(e,t)}pick(e){return e[this.getNext(0,e.length-1)]}shuffle(e){const t=[...e];for(let l=t.length-1;l>0;l--){const s=this.getNext(0,l);[t[l],t[s]]=[t[s],t[l]]}return t}}class H extends C{constructor(t){super(t);x(this,"index");this.index=t}next(t,l){if(l<=t)return t;this.index=this.index*1664525+1013904223>>>0;const s=l-t+1;return t+this.index%s}}function A(c){return new H(c)}class I{constructor(e,t,l){x(this,"solution");x(this,"skeleton");this.board=e;const s=F(e),i=I.solve(s,Array.from({length:e.cellcount},()=>0),l);if(i===null)throw new Error("Unsolvable board");this.solution=i,this.skeleton=[...this.solution];const r=l.shuffle(Array.from({length:e.cellcount},(a,m)=>m));for(const a of r){const m=this.skeleton[a];this.skeleton[a]=0;const y=E(a,s,this.skeleton).filter(w=>w!==m);if(y.length===0)continue;let v=!1;for(const w of y)if(this.skeleton[a]=w,I.solve(s,[...this.skeleton],l)!==null){v=!0;break}this.skeleton[a]=v?m:0}for(let a=0;a<e.size;a++)for(let m=0;m<e.size;m++){const y=a*e.size+m,v=e.rows[a],w=e.columns[m];let N=!1,O=!1,G=!1,R=!1,d=0;for(const M of v)m===d&&(N=!0),d+=M-1,m===d&&(O=!0),d+=1;d=0;for(const M of w)a===d&&(G=!0),d+=M-1,a===d&&(R=!0),d+=1;N&&O&&G&&R&&(this.skeleton[y]=1)}const n=p(t),o=l.shuffle(Array.from({length:e.cellcount},(a,m)=>new k(m)).filter(a=>a.getValue(this.skeleton)===0)).map(a=>a.index),f=Math.floor(e.cellcount*(n/100)),u=e.cellcount-o.length,h=Math.max(0,f-u);o.slice(0,h).forEach(a=>{const m=this.solution[a];this.skeleton[a]=m})}static propagate(e,t){let l=!0;for(;l;){l=!1;for(let s=0;s<t.length;s++){if(t[s]!==0)continue;const i=E(s,e,t);if(i.length===0)return!1;i.length===1&&(t[s]=i[0],l=!0)}}return!0}static solve(e,t,l){if(!this.propagate(e,t))return null;let s,i;for(let n=0;n<t.length;n++){if(t[n]!==0)continue;const o=E(n,e,t);if(o.length===0)return null;if((i===void 0||o.length<i.length)&&(s=n,i=o,o.length===1))break}if(s===void 0)return t;const r=i;for(const n of r){t[s]=n;const o=this.solve(e,t,l);if(o!==null)return o;t[s]=0}return null}}function E(c,e,t){const l=e[c].colSegment.map(o=>o.getValue(t)),s=e[c].rowSegment.map(o=>o.getValue(t)),i=new Set([...l,...s].filter(o=>o!==0)),r=Math.min(l.length,s.length),n=[];for(let o=1;o<=r;o++)i.has(o)||n.push(o);return n}class k{constructor(e){this.index=e}getValue(e){return e[this.index]}}function F(c){const e={},t=(l,s)=>l*c.size+s;for(let l=0;l<c.size;l++)for(let s=0;s<c.size;s++){const i=t(l,s),r=[];let n=0;for(const f of c.rows[l]){const u=n+f;if(s>=n&&s<u){for(let h=n;h<u;h++)r.push(new k(t(l,h)));break}n=u}const o=[];n=0;for(const f of c.columns[s]){const u=n+f;if(l>=n&&l<u){for(let h=n;h<u;h++)o.push(new k(t(h,s)));break}n=u}e[i]={rowSegment:r,colSegment:o}}return e}function B(c,e,t){return new I(c,e,t)}class L{constructor(e,t){x(this,"cellcount");x(this,"rows");x(this,"columns");if(this.size=e,e<5)throw new Error(`Size ${e} is too small`);this.cellcount=this.size*this.size;const l=Array.from({length:this.size},(u,h)=>h),s=Math.max(Math.floor(this.size/2-1)-t.getNext(1),2),i=t.shuffle([...l]).slice(0,s),r=t.shuffle([...l]).slice(0,s),n=Array.from({length:this.size},()=>{});for(const u of i)n[u]=[this.size];const o=Array.from({length:this.size},()=>{});for(const u of r)o[u]=[this.size];if(!S(n,o,t))throw new Error("Unsolvable div board");this.rows=n.map(u=>u.map(h=>h)),this.columns=o.map(u=>u.map(h=>h))}}function W(c,e){const t=c.length,l=Array.from({length:t},()=>Array(t).fill(0)),s=Array.from({length:t},()=>Array(t).fill(0)),i=(r,n)=>{let o=0;for(let f=0;f<r.length;f++){const u=r[f];if(o<=n&&o+u>n)return f;o+=u}throw Error(`Unable to find value ${n} in ${r}`)};for(let r=0;r<t;r++)for(let n=0;n<t;n++){const o=n,f=i(e[o],r);l[r][n]=e[o][f]}for(let r=0;r<t;r++)for(let n=0;n<t;n++){const o=n,f=i(c[o],r);s[r][n]=c[o][f]}return{rowMap:l,colMap:s}}function T(c,e){const t=c.length,{rowMap:l,colMap:s}=W(c,e);for(let i=0;i<t;i++){let r=0;for(const n of c[i]){const o=l[i].slice(r,r+n).sort((f,u)=>u-f);for(let f=0;f<n;f++){const u=n-f;if(o[f]<u)return!1}r+=n}}for(let i=0;i<t;i++){let r=0;for(const n of e[i]){const o=s[i].slice(r,r+n).sort((f,u)=>u-f);for(let f=0;f<n;f++){const u=n-f;if(o[f]<u)return!1}r+=n}}return!0}function S(c,e,t){const l=c.length,s=c.findIndex(o=>o===void 0),i=s===-1?e.findIndex(o=>o===void 0):-1;if(s===-1&&i===-1)return!0;const r={get(){return s!==-1?c[s]:e[i]},set(o){s!==-1?c[s]=o:e[i]=o},reset(){this.set(void 0)}},n=t.shuffle(Array.from({length:l-1},(o,f)=>[f+1,l-(f+1)]));for(const o of n)if(r.set(o),!!T([...c].map(f=>f===void 0?[l]:f),[...e].map(f=>f===void 0?[l]:f))&&S(c,e,t))return!0;return r.reset(),!1}function U(c,e){const t=V(c);for(;;){const l=e.getNext(Number.MAX_SAFE_INTEGER),s=A(l),i=new L(t,s);let r;try{r=B(i,c,s)}catch(n){if(n.message!=="Unsolvable board")throw n}if(r)return[i,r]}}self.onmessage=async c=>{const{level:e,difficulty:t}=c.data,l=A(e);try{const[s,i]=U(t,l),r={board:s,solution:i};self.postMessage(r)}catch(s){const i={error:s.message};self.postMessage(i)}}})();
